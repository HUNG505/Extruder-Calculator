<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>電纜押出製程智慧計算器 V1.1</title>
    
    <!-- 引入 React 與 Tailwind (透過 CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* iOS Safari 優化：防止輸入框縮放 */
        input, select, textarea {
            font-size: 16px !important; 
        }
        /* 增加觸控目標大小 */
        .ios-touch-target {
            min-height: 44px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 touch-manipulation">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Icon 組件庫 (內嵌 SVG 以確保離線可用) ---
        const Icons = {
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Calculator: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            AlertTriangle: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>,
            ArrowRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>,
            Gauge: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>,
            Scale: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h2c2 0 5-1 7-2 2 1 5 2 7 2h2"/></svg>,
            Ruler: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L2.7 8.7a2.41 2.41 0 0 1 0-3.4l2.6-2.6a2.41 2.41 0 0 1 3.4 0Z"/><path d="m14.5 12.5 2-2"/><path d="m11.5 9.5 2-2"/><path d="m8.5 6.5 2-2"/><path d="m17.5 15.5 2-2"/></svg>,
            Factory: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 20a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8l-7 5V8l-7 5V4a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><line x1="17" x2="17" y1="13" y2="22"/><line x1="7" x2="7" y1="13" y2="22"/></svg>,
            CheckCircle2: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Info: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
        };

        // --- PRD V1.1 資料庫 ---
        const MATERIAL_GROUPS = {
            PVC_LDPE: 'pvc_ldpe',
            HDPE_XLPE: 'hdpe_xlpe',
            LSHF: 'lshf',
        };

        const MATERIALS = [
            { name: 'PVC', density: 1.40, group: MATERIAL_GROUPS.PVC_LDPE },
            { name: 'PE', density: 0.92, group: MATERIAL_GROUPS.PVC_LDPE },
            { name: 'XLPE', density: 0.93, group: MATERIAL_GROUPS.HDPE_XLPE },
            { name: 'Nylon', density: 1.02, group: MATERIAL_GROUPS.HDPE_XLPE },
            { name: 'LSHF', density: 1.55, group: MATERIAL_GROUPS.LSHF },
        ];

        // 機台規格表 (含不同材料的最大產能)
        const MACHINES = [
            { name: 'Extruder 50mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 110, [MATERIAL_GROUPS.HDPE_XLPE]: 66, [MATERIAL_GROUPS.LSHF]: 75 } },
            { name: 'Extruder 60mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 170, [MATERIAL_GROUPS.HDPE_XLPE]: 90, [MATERIAL_GROUPS.LSHF]: 113 } },
            { name: 'Extruder 75mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 270, [MATERIAL_GROUPS.HDPE_XLPE]: 165, [MATERIAL_GROUPS.LSHF]: 138 } },
            { name: 'Extruder 90mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 380, [MATERIAL_GROUPS.HDPE_XLPE]: 195, [MATERIAL_GROUPS.LSHF]: 163 } },
            { name: 'Extruder 100mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 450, [MATERIAL_GROUPS.HDPE_XLPE]: 270, [MATERIAL_GROUPS.LSHF]: 225 } },
            { name: 'Extruder 120mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 650, [MATERIAL_GROUPS.HDPE_XLPE]: 450, [MATERIAL_GROUPS.LSHF]: 375 } },
            { name: 'Extruder 150mm', limits: { [MATERIAL_GROUPS.PVC_LDPE]: 1000, [MATERIAL_GROUPS.HDPE_XLPE]: 675, [MATERIAL_GROUPS.LSHF]: 563 } },
        ];

        // --- 元件 (Components) ---
        const InputGroup = ({ label, icon: Icon, children, error }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-slate-700 mb-1 flex items-center gap-1">
                    {Icon && <span className="text-slate-500"><Icon /></span>}
                    {label}
                </label>
                {children}
                {error && <p className="text-red-500 text-xs mt-1 flex items-center gap-1"><Icons.AlertTriangle /> {error}</p>}
            </div>
        );

        const ResultCard = ({ title, value, unit, subtext, highlight = false, warning = false }) => (
            <div className={`p-4 rounded-xl border ${highlight ? (warning ? 'bg-red-50 border-red-200' : 'bg-blue-50 border-blue-200') : 'bg-white border-slate-100'} shadow-sm flex flex-col items-center justify-center text-center transition-all duration-300 relative overflow-hidden`}>
                <p className={`text-xs uppercase tracking-wider font-semibold mb-1 ${highlight ? (warning ? 'text-red-600' : 'text-blue-600') : 'text-slate-500'}`}>
                    {title}
                </p>
                <div className="flex items-baseline gap-1 relative z-10">
                    <span className={`text-2xl font-bold ${highlight ? (warning ? 'text-red-700' : 'text-blue-700') : 'text-slate-800'}`}>
                        {value}
                    </span>
                    <span className="text-xs text-slate-500 font-medium">{unit}</span>
                </div>
                {subtext && <p className="text-xs text-slate-400 mt-1 relative z-10">{subtext}</p>}
            </div>
        );

        // --- 主應用程式 (App) ---
        function App() {
            // V1.1 預設值: Machine: 75mm (index 2), Material: PVC (index 0), OD: 5, ID: 3
            const [machineIndex, setMachineIndex] = useState(2);
            const [materialIndex, setMaterialIndex] = useState(0);
            const [density, setDensity] = useState(MATERIALS[0].density);
            const [od, setOd] = useState(5);
            const [id, setId] = useState(3);

            // 模式: 'output' (求押出量) | 'speed' (求線速度)
            const [mode, setMode] = useState('output');

            // 預設參數
            const [lineSpeed, setLineSpeed] = useState(100);
            const [targetOutput, setTargetOutput] = useState(150);

            const [errors, setErrors] = useState({});

            // 密度重置邏輯
            useEffect(() => {
                setDensity(MATERIALS[materialIndex].density);
            }, [materialIndex]);

            // 核心計算
            const calculations = useMemo(() => {
                const currentMaterialObj = MATERIALS[materialIndex];
                const currentMachineObj = MACHINES[machineIndex];
                
                // V1.1 核心: 根據材料群組決定該機台的最大產能
                const currentMaxOutput = currentMachineObj.limits[currentMaterialObj.group];

                let newErrors = {};
                if (Number(id) >= Number(od)) newErrors.dims = '內徑必須小於外徑';
                if (Number(od) <= 0 || Number(id) < 0) newErrors.dims = '數值異常';
                setErrors(newErrors);

                // 截面積 A = (π/4)(OD²-ID²)
                const area = (Math.PI / 4) * (Math.pow(Number(od), 2) - Math.pow(Number(id), 2));
                
                // 單位重 W = A * Density / 1000
                const weightPerMeter = (area * Number(density)) / 1000;

                let calculatedOutput = 0;
                let calculatedSpeed = 0;
                let isOverload = false;

                if (mode === 'output') {
                    // Q = W * V * 60
                    calculatedOutput = weightPerMeter * Number(lineSpeed) * 60;
                    isOverload = calculatedOutput > currentMaxOutput;
                } else {
                    // V = Q / (W * 60)
                    if (weightPerMeter > 0) calculatedSpeed = Number(targetOutput) / (weightPerMeter * 60);
                    isOverload = Number(targetOutput) > currentMaxOutput;
                }

                return {
                    area: Math.max(0, area),
                    weightPerMeter: Math.max(0, weightPerMeter),
                    resultOutput: Math.max(0, calculatedOutput),
                    resultSpeed: Math.max(0, calculatedSpeed),
                    isOverload,
                    currentMachineName: currentMachineObj.name,
                    currentMaxOutput
                };
            }, [machineIndex, materialIndex, density, od, id, mode, lineSpeed, targetOutput]);

            const handleSetMaxOutput = () => {
                setTargetOutput(calculations.currentMaxOutput);
            };

            return (
                <div className="min-h-screen flex justify-center py-6 px-4">
                    <div className="w-full max-w-md bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col">
                        
                        <div className="bg-slate-900 p-5 text-white">
                            <div className="flex justify-between items-center mb-1">
                                <h1 className="text-xl font-bold flex items-center gap-2">
                                    <span className="text-blue-400"><Icons.Settings /></span>
                                    押出量計算機
                                </h1>
                                <span className="text-xs bg-blue-600 px-2 py-1 rounded text-blue-100">V1.1</span>
                            </div>
                            <p className="text-slate-400 text-sm">PRD V1.1 | 動態產能匹配</p>
                        </div>

                        <div className="flex-1 overflow-y-auto">
                            <div className="p-5 border-b border-slate-100 space-y-4">
                                
                                {/* 材料選擇 (影響 Max Output) */}
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup label="材料" icon={Icons.CheckCircle2}>
                                        <select 
                                            value={materialIndex}
                                            onChange={(e) => setMaterialIndex(Number(e.target.value))}
                                            className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none ios-touch-target"
                                        >
                                            {MATERIALS.map((m, idx) => (
                                                <option key={idx} value={idx}>{m.name}</option>
                                            ))}
                                        </select>
                                    </InputGroup>
                                    <InputGroup label="密度 (g/cm³)" icon={Icons.Scale}>
                                        <input 
                                            type="number" step="0.01" inputMode="decimal"
                                            value={density} onChange={(e) => setDensity(e.target.value)}
                                            className="w-full p-3 bg-white border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-blue-600 font-semibold ios-touch-target"
                                        />
                                    </InputGroup>
                                </div>

                                {/* 機台選擇 (顯示動態 Max) */}
                                <InputGroup label="機台型號" icon={Icons.Factory}>
                                    <div className="relative">
                                        <select 
                                            value={machineIndex}
                                            onChange={(e) => setMachineIndex(Number(e.target.value))}
                                            className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none appearance-none ios-touch-target"
                                        >
                                            {MACHINES.map((m, idx) => {
                                                const currentMatGroup = MATERIALS[materialIndex].group;
                                                const max = m.limits[currentMatGroup];
                                                return <option key={idx} value={idx}>{m.name} (Max: {max} kg/hr)</option>;
                                            })}
                                        </select>
                                        <div className="absolute right-3 top-3.5 pointer-events-none text-slate-400">▼</div>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-1 flex items-center gap-1">
                                        <Icons.Info /> 當前 Max Output 依據 {MATERIALS[materialIndex].name} 設定
                                    </p>
                                </InputGroup>

                                {/* 尺寸 OD / ID */}
                                <div className="grid grid-cols-2 gap-4">
                                    <InputGroup label="外徑 OD (mm)" icon={Icons.Ruler} error={errors.dims}>
                                        <input 
                                            type="number" step="0.1" inputMode="decimal"
                                            value={od} onChange={(e) => setOd(e.target.value)}
                                            className={`w-full p-3 bg-slate-50 border ${errors.dims ? 'border-red-300 bg-red-50' : 'border-slate-200'} rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-center ios-touch-target`}
                                        />
                                    </InputGroup>
                                    <InputGroup label="內徑 ID (mm)" icon={Icons.Ruler}>
                                        <input 
                                            type="number" step="0.1" inputMode="decimal"
                                            value={id} onChange={(e) => setId(e.target.value)}
                                            className={`w-full p-3 bg-slate-50 border ${errors.dims ? 'border-red-300 bg-red-50' : 'border-slate-200'} rounded-lg focus:ring-2 focus:ring-blue-500 outline-none font-mono text-center ios-touch-target`}
                                        />
                                    </InputGroup>
                                </div>
                            </div>

                            {/* Tabs */}
                            <div className="px-5 pt-5 pb-2">
                                <div className="bg-slate-100 p-1 rounded-xl flex">
                                    <button onClick={() => setMode('output')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 flex justify-center items-center gap-2 ios-touch-target ${mode === 'output' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                        <Icons.Calculator /> 求押出量
                                    </button>
                                    <button onClick={() => setMode('speed')} className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all duration-200 flex justify-center items-center gap-2 ios-touch-target ${mode === 'speed' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                        <Icons.Gauge /> 求線速度
                                    </button>
                                </div>
                            </div>

                            {/* 動態輸入區 */}
                            <div className="px-5 py-2">
                                {mode === 'output' ? (
                                    <InputGroup label="線速度 (m/min)" icon={Icons.Gauge}>
                                        <input 
                                            type="number" inputMode="decimal"
                                            value={lineSpeed} onChange={(e) => setLineSpeed(e.target.value)}
                                            className="w-full p-4 text-lg bg-blue-50 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-blue-900 font-bold ios-touch-target"
                                            placeholder="輸入速度..."
                                        />
                                    </InputGroup>
                                ) : (
                                    <InputGroup label="目標押出量 (kg/hr)" icon={Icons.Scale}>
                                        <div className="relative">
                                            <input 
                                                type="number" inputMode="decimal"
                                                value={targetOutput} onChange={(e) => setTargetOutput(e.target.value)}
                                                className="w-full p-4 text-lg bg-blue-50 border border-blue-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-blue-900 font-bold ios-touch-target"
                                                placeholder="輸入產量..."
                                            />
                                            <button onClick={handleSetMaxOutput} className="absolute right-2 top-2 bottom-2 px-3 bg-blue-100 hover:bg-blue-200 text-blue-700 text-xs font-medium rounded-lg transition-colors flex items-center gap-1">
                                                帶入 Max <Icons.ArrowRight />
                                            </button>
                                        </div>
                                    </InputGroup>
                                )}
                            </div>

                            {/* 警告區 */}
                            {calculations.isOverload && (
                                <div className="px-5 py-2">
                                    <div className="bg-red-50 border-l-4 border-red-500 p-3 rounded-r-lg flex items-start gap-3 animate-pulse">
                                        <span className="text-red-500 mt-0.5"><Icons.AlertTriangle /></span>
                                        <div>
                                            <h3 className="text-sm font-bold text-red-700">警告：超出機台負載！</h3>
                                            <p className="text-xs text-red-600 mt-1">
                                                使用 {MATERIALS[materialIndex].name} 時，{calculations.currentMachineName} 最大極限為 {calculations.currentMaxOutput} kg/hr。
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 結果區 */}
                            <div className="p-5 bg-slate-50 mt-2 space-y-3 pb-8">
                                <h2 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">計算結果</h2>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <ResultCard title="截面積 Area" value={calculations.area.toFixed(2)} unit="mm²" />
                                    <ResultCard title="單位重 Unit W" value={calculations.weightPerMeter.toFixed(4)} unit="kg/m" />
                                </div>
                                {mode === 'output' ? (
                                    <ResultCard title="預估押出量 Output" value={calculations.resultOutput.toFixed(1)} unit="kg/hr" highlight={true} warning={calculations.isOverload} subtext={`目前上限: ${calculations.currentMaxOutput} kg/hr`} />
                                ) : (
                                    <ResultCard title="建議線速度 Speed" value={calculations.resultSpeed.toFixed(1)} unit="m/min" highlight={true} warning={calculations.isOverload} subtext={calculations.isOverload ? "不可行 (超載)" : "參數可行"} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>